<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* View switching and modal transitions */
        .view, .modal-overlay {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .view.active {
            display: block; /* Lobby and Game views are blocks */
            opacity: 1;
        }
        .modal-overlay.active {
             display: flex; /* Use flex for centering modal */
             opacity: 1;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 110;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: toast-in 0.5s forwards;
        }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        .toast.info { background-color: #3b82f6; }
        .toast.error { background-color: #ef4444; }
        .toast.success { background-color: #22c55e; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen">

    <!-- Main App Container -->
    <div class="w-full max-w-4xl mx-auto p-4">
        <div id="app-container" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">
            <!-- Lobby View -->
            <div id="lobby-view" class="view active">
                <h1 class="text-4xl font-bold text-center text-slate-900 mb-2">Connect</h1>
                <p class="text-center text-slate-500 mb-8">A collaborative word guessing game.</p>
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
                    <label for="username-input" class="block text-sm font-medium text-slate-700 mb-1 text-center">Your Nickname:</label>
                    <input type="text" id="username-input" class="w-full font-mono text-lg text-center text-indigo-600 bg-transparent border-0 focus:ring-0" value="Connecting...">
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="create-game-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Create New Game
                    </button>
                </div>
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-300"></div></div>
                    <div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-slate-500">OR</span></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="join-code-input" placeholder="Paste Share Code to join" class="flex-grow w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="join-game-btn" class="w-full sm:w-auto bg-slate-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Join Game
                    </button>
                </div>
            </div>
            <!-- Game View (Dynamically populated) -->
            <div id="game-view" class="view"></div>
        </div>
        <p class="text-center text-sm text-slate-400 mt-4">Powered by Firebase & Tailwind CSS</p>
    </div>

    <!-- End of Round Modal -->
    <div id="end-round-modal" class="modal-overlay">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
            <h2 id="modal-title" class="text-3xl font-bold text-slate-900 mb-4">Round Over!</h2>
            <p id="modal-body" class="text-slate-600 mb-6">The secret word was:</p>
            <p id="modal-secret-word" class="font-mono text-2xl bg-slate-100 text-indigo-600 py-2 px-4 rounded-lg inline-block mb-6"></p>
            <button id="play-again-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700">Play Again</button>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Firebase and Game Logic Script -->
    <script type="module">
        // Import Firebase configuration
        import { firebaseConfig } from './config.js';
        
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        

        // --- 1. CONFIGURATION & INITIALIZATION ---
        // TODO: Replace with your actual Firebase configuration from your Firebase project.
        // 1. Go to the Firebase console (console.firebase.google.com).
        // 2. Create a new project or use an existing one.
        // 3. Add a new Web App to your project.
        // 4. Copy the firebaseConfig object here.
        // const firebaseConfig = {
        //   apiKey: "YOUR_API_KEY",
        //   authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        //   projectId: "YOUR_PROJECT_ID",
        //   storageBucket: "YOUR_PROJECT_ID.appspot.com",
        //   messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        //   appId: "YOUR_APP_ID",
        //   measurementId: "YOUR_MEASUREMENT_ID",
        // };

       
        let db, auth, analytics;
        let currentUserId = null;
        let currentGameId = null;
        let unsubscribeFromGame = null;

        // DOM Element References
        const usernameInput = document.getElementById('username-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const joinCodeInput = document.getElementById('join-code-input');
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        const endRoundModal = document.getElementById('end-round-modal');

        // --- 2. UTILITY FUNCTIONS ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toast-out 0.5s forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        }

        function getGameRef(roomId) {
            return doc(db, "game_rooms", roomId);
        }

        function generateCreativeUsername() {
            const adjectives = ["Agile", "Bright", "Clever", "Daring", "Eager", "Fearless", "Gallant", "Happy", "Jolly", "Keen"];
            const animals = ["Alpaca", "Bear", "Cat", "Dolphin", "Eagle", "Fox", "Giraffe", "Hippo", "Iguana", "Jaguar"];
            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
            return `${randomAdjective}${randomAnimal}${Math.floor(Math.random() * 900) + 100}`;
        }

        // --- 3. AUTHENTICATION ---
        async function initializeAppAndAuth() {
            try {
                // Check if the Firebase config has been filled out
                if (firebaseConfig.apiKey.startsWith("REPLACE_WITH_YOUR")) {
                    console.error("Firebase configuration is not set. Please update it in index-web.html with your project's credentials.");
                    usernameInput.value = 'Config Error';
                    showToast("Firebase is not configured. Please get your credentials from the Firebase Console.", "error");
                    createGameBtn.disabled = true;
                    joinGameBtn.disabled = true;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if (usernameInput.value === 'Connecting...' || usernameInput.value === 'Connection Failed') {
                           usernameInput.value = generateCreativeUsername();
                        }
                        createGameBtn.disabled = false;
                        joinGameBtn.disabled = false;
                    } else {
                        currentUserId = null;
                        createGameBtn.disabled = true;
                        joinGameBtn.disabled = true;
                    }
                });
                
                // Use anonymous authentication
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                usernameInput.value = 'Connection Failed';
                showToast("Could not connect to game service. Please check your Firebase configuration.", "error");
            }
        }

        // --- 4. VIEW MANAGEMENT ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function showModal(title, body, secretWord) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal-secret-word').textContent = secretWord;
            endRoundModal.classList.add('active');
        }
        
        function hideModal() {
            endRoundModal.classList.remove('active');
        }

        // --- 5. LOBBY LOGIC ---
        async function createGame() {
            if (!currentUserId) return showToast("Authenticating... please wait.", "info");
            const customName = usernameInput.value.trim();
            if (!customName) return showToast("Please enter a nickname.", "error");

            const newRoomId = crypto.randomUUID().substring(0, 6).toUpperCase();
            const gameRef = getGameRef(newRoomId);

            try {
                await setDoc(gameRef, {
                    roomId: newRoomId,
                    gamePhase: 'lobby',
                    players: { [currentUserId]: { role: 'setter', name: customName } },
                    gameHistory: [ `${customName} created the game.` ]
                });
                
                // Creator directly enters the game view
                currentGameId = newRoomId;
                showView('game-view');
                subscribeToGame(newRoomId);

            } catch (error) {
                console.error("Error creating game:", error);
                showToast("Could not create game. Please try again.", "error");
            }
        }

        async function joinGame() {
            const joinCode = joinCodeInput.value.trim();
            if (!joinCode) { showToast("Please paste a Room Code.", "info"); return; }
            if (!currentUserId) { showToast("Still connecting... Please try again in a moment.", "info"); return; }
            const customName = usernameInput.value.trim();
            if (!customName || customName === 'Connecting...') { showToast("Please set a nickname first.", "error"); return; }
            
            const roomIdToJoin = joinCode;
            const gameRef = getGameRef(roomIdToJoin);

            try {
                const gameDoc = await getDoc(gameRef);
                if (!gameDoc.exists()) { showToast("Game room not found.", "error"); return; }
                
                currentGameId = roomIdToJoin;
                const gameData = gameDoc.data();

                if (!gameData.players[currentUserId]) {
                    await updateDoc(gameRef, {
                        [`players.${currentUserId}`]: { role: 'guesser', name: customName },
                        gameHistory: arrayUnion(`${customName} joined the game.`)
                    });
                }
                
                showView('game-view');
                subscribeToGame(roomIdToJoin);
            } catch (error) {
                console.error("Error joining game:", error);
                showToast("Failed to join game. Check the code and your connection.", "error");
            }
        }

        // --- 6. GAME STATE & RENDERING ---
        function subscribeToGame(roomId) {
            if (unsubscribeFromGame) unsubscribeFromGame();
            const gameRef = getGameRef(roomId);
            unsubscribeFromGame = onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) {
                    showToast("The game room was deleted.", "info");
                    showView('lobby-view');
                    currentGameId = null;
                    if(unsubscribeFromGame) unsubscribeFromGame();
                    return;
                }
                const gameData = doc.data();
                renderGame(gameData);
                handleGamePhaseChange(gameData);
            }, (error) => {
                console.error("Snapshot listener error:", error);
                showToast("Connection to game lost.", "error");
            });
        }
        
        function handleGamePhaseChange(gameData) {
            if (gameData.gamePhase === 'ended' && !endRoundModal.classList.contains('active')) {
                const playerWon = gameData.winner === 'guessers';
                showModal(
                    playerWon ? "You Win!" : "Round Over!",
                    `The ${gameData.winner} won. The secret word was:`,
                    gameData.secretWord
                );
            } else if (gameData.gamePhase !== 'ended') {
                hideModal();
            }
        }

        function renderGame(gameData) {
            const player = gameData.players[currentUserId];
            if (!player) return;
            let content = '';
            if (gameData.gamePhase === 'lobby') {
                content = renderLobbyPhase(gameData, player);
            } else if (gameData.gamePhase === 'setting_word') {
                const setter = Object.values(gameData.players).find(p => p.role === 'setter');
                content = player.role === 'setter' 
                    ? renderSetterWordChoice() 
                    : `<p class="text-center text-slate-500 text-lg">Waiting for ${setter?.name || 'the Setter'} to choose a word...</p>`;
            } else if (gameData.gamePhase === 'guessing' || gameData.gamePhase === 'ended') {
                content = renderGuessingPhase(gameData, player);
            }
            gameView.innerHTML = content;
            addEventListenersToGame(gameData);
        }

        // --- 7. UI TEMPLATES ---
        function renderLobbyPhase(gameData, player) {
            const playersList = Object.keys(gameData.players).map(uid => {
                const p = gameData.players[uid];
                return `<li class="font-semibold p-2 rounded ${uid === currentUserId ? 'bg-indigo-100' : ''}">${p.name} (${p.role})</li>`;
            }).join('');
            let content = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold mb-2">Game Lobby</h2>
                    <div class="flex items-center justify-center gap-2 font-mono text-indigo-600 mb-4">
                        <span>Share this game:</span>
                        <button id="copy-share-link-btn" title="Copy Room Code" class="p-1 rounded-md hover:bg-indigo-100 flex items-center gap-1 bg-slate-100 border">
                            <span>${gameData.roomId}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/></svg>
                        </button>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Players:</h3>
                    <ul class="space-y-1 mb-6">${playersList}</ul>`;
            if (player.role === 'setter') {
                content += `<button id="start-game-round-btn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700">Start Game</button>`;
            } else {
                content += `<p class="text-slate-500">Waiting for the Word Setter to start the game...</p>`;
            }
            content += `</div>`;
            return content;
        }

        function renderSetterWordChoice() {
            return `<div class="text-center"><h2 class="text-2xl font-bold text-slate-900 mb-4">You are the Word Setter!</h2><p class="text-slate-600 mb-6">Choose a secret word (5-12 letters).</p><form id="set-word-form" class="flex flex-col sm:flex-row gap-2"><input type="text" id="secret-word-input" class="flex-grow w-full px-4 py-3 border rounded-lg" required minlength="5" maxlength="12" pattern="[a-zA-Z]+"><button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg">Set Word</button></form></div>`;
        }
        
        function renderGuessingPhase(gameData, player) {
            const revealedWord = gameData.secretWord.split('').map((letter, index) => index < gameData.revealedCount ? `<span class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center text-2xl font-bold bg-slate-200 rounded-md">${letter.toUpperCase()}</span>` : `<span class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center bg-slate-200 rounded-md"></span>`).join('');
            
            const { players, currentReference, clueGiverTurn } = gameData;
            const guesserIds = Object.keys(players).filter(id => players[id].role === 'guesser').sort();
            let nextClueGiverId = null;
            if (guesserIds.length > 0) {
                const turnIndex = clueGiverTurn || 0;
                nextClueGiverId = guesserIds[turnIndex % guesserIds.length];
            }
            const clueGiverId = currentReference?.clueGiverId || nextClueGiverId;

            const playersList = Object.keys(gameData.players).map(uid => {
                const p = gameData.players[uid];
                let roleDisplay, roleClasses;

                if (p.role === 'setter') {
                    roleDisplay = 'setter';
                    roleClasses = 'bg-red-100 text-red-800';
                } else if (uid === clueGiverId) {
                    roleDisplay = 'leader';
                    roleClasses = 'bg-blue-300 text-blue-800';
                } else {
                    roleDisplay = 'guesser';
                    roleClasses = 'bg-blue-100 text-blue-800';
                }

                const hasGuessed = gameData.currentReference?.guesses?.[uid];
                const badgeHTML = hasGuessed ? '<span class="ml-2 w-2.5 h-2.5 bg-green-500 rounded-full"></span>' : '';

                return `<li class="flex items-center justify-between p-2 rounded-lg ${uid === currentUserId ? 'bg-indigo-50' : ''}">
                            <span class="font-semibold truncate text-sm" title="${p.name}">${p.name}</span>
                            <span class="flex items-center">
                                <span class="text-xs font-mono px-2 py-1 rounded-full ${roleClasses}">${roleDisplay}</span>
                                ${badgeHTML}
                            </span>
                        </li>`;
            }).join('');

            const gameAreaContent = player.role === 'guesser' ? renderGuesserArea(gameData) : renderSetterArea(gameData);
            return `<div class="flex justify-between items-center mb-4"><div><h2 class="text-2xl font-bold">Game In Progress</h2><div class="flex items-center gap-2 font-mono text-indigo-600"><span>Room Code:</span><button id="copy-share-link-btn" title="Copy Room Code" class="p-1 rounded-md hover:bg-indigo-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/></svg></button></div></div><div class="text-right"><p class="text-sm text-slate-600">Direct Guesses</p><p class="text-2xl font-bold">${gameData.directGuessesLeft}</p></div></div><div class="mb-6 p-4 bg-slate-50 rounded-lg flex justify-center gap-2 flex-wrap">${revealedWord}</div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2 bg-white p-4 rounded-lg border">${gameAreaContent}</div><div class="bg-white p-4 rounded-lg border"><h3 class="font-bold text-lg mb-2">Players</h3><ul class="space-y-1">${playersList}</ul><h3 class="font-bold text-lg mt-4 mb-2">History</h3><ul class="text-xs text-slate-500 space-y-1 h-32 overflow-y-auto">${gameData.gameHistory.slice().reverse().map(h => `<li>- ${h}</li>`).join('')}</ul></div></div>`;
        }
        
        function renderGuesserArea(gameData) {
            const { currentReference, players, clueGiverTurn } = gameData;
            const guesserIds = Object.keys(players).filter(id => players[id].role === 'guesser').sort();
            
            let nextClueGiverId = null;
            if (guesserIds.length > 0) {
                const turnIndex = clueGiverTurn || 0;
                nextClueGiverId = guesserIds[turnIndex % guesserIds.length];
            }
            
            const clueGiverId = currentReference?.clueGiverId || nextClueGiverId;

            const isClueGiver = currentUserId === clueGiverId;
            let referenceUI = '';
            if (!currentReference) {
                 referenceUI = isClueGiver ? `<h3 class="font-bold text-lg mb-2">You are the Clue Giver!</h3><p class="text-slate-600 mb-4">Give a clue for a reference word.</p><form id="set-clue-form"><input type="text" id="reference-word-input" placeholder="Your Reference Word" class="w-full px-4 py-2 mb-2 border rounded-lg" required><input type="text" id="clue-input" placeholder="Your Clue for the Word" class="w-full px-4 py-2 mb-4 border rounded-lg" required><button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg">Set Clue</button></form>` : `<p class="text-center text-slate-500">Waiting for ${players[clueGiverId]?.name || 'a Clue Giver'} to provide a clue...</p>`;
            } else {
                const myGuess = currentReference.guesses?.[currentUserId];
                if (myGuess) { referenceUI = `<p class="text-center text-lg text-green-600">Your guess '${myGuess}' is locked in! Waiting for others...</p>`; }
                else if (currentUserId === currentReference.clueGiverId) { referenceUI = `<p class="text-center text-slate-500">You gave the clue. Waiting for guesses...</p>`; }
                else { referenceUI = `<h3 class="font-bold text-lg mb-2">Clue from ${players[currentReference.clueGiverId].name}:</h3><p class="text-slate-600 mb-4 text-xl font-semibold">"${currentReference.clue}"</p><form id="guesser-guess-form"><input type="text" id="guesser-reference-guess-input" placeholder="What is the reference word?" class="w-full px-4 py-2 mb-4 border rounded-lg" required><button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg">I Know It!</button></form>`; }
            }
            return `<div class="mb-4">${referenceUI}</div><div class="mt-6 border-t pt-4"><h3 class="font-bold text-lg mb-2">Guess the Secret Word</h3><form id="direct-guess-form" class="flex gap-2"><input type="text" id="direct-guess-input" placeholder="Type the full secret word" class="flex-grow w-full px-4 py-2 border rounded-lg"><button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg" ${gameData.directGuessesLeft <= 0 ? 'disabled' : ''}>Guess</button></form></div>`;
        }

        function renderSetterArea(gameData) {
            const { currentReference } = gameData;
            if (!currentReference) return `<p class="text-center text-slate-500">Waiting for the Guessers to start a reference...</p>`;
            if (currentReference.setterAttempt) return `<p class="text-center text-lg text-blue-600">You guessed '${currentReference.setterAttempt}'. Waiting for resolution...</p>`;
            return `<h3 class="font-bold text-lg mb-2">Sabotage the Guessers!</h3><p class="text-slate-600 mb-2">Clue: <span class="font-semibold text-xl">"${currentReference.clue}"</span></p><p class="text-slate-600 mb-4">Guess the reference word to stop them!</p><form id="setter-guess-form" class="flex gap-2"><input type="text" id="setter-reference-guess-input" placeholder="Guess the reference word" class="flex-grow w-full px-4 py-2 border rounded-lg"><button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Guess</button></form>`;
        }
        
        // --- 8. EVENT HANDLING & GAME LOGIC ---
        function addEventListenersToGame(gameData) {
            document.getElementById('start-game-round-btn')?.addEventListener('click', startGameRound);
            document.getElementById('set-word-form')?.addEventListener('submit', handleSetWord);
            document.getElementById('set-clue-form')?.addEventListener('submit', handleSetClue);
            document.getElementById('guesser-guess-form')?.addEventListener('submit', handleGuesserReferenceGuess);
            document.getElementById('setter-guess-form')?.addEventListener('submit', handleSetterReferenceGuess);
            document.getElementById('direct-guess-form')?.addEventListener('submit', handleDirectGuess);
            document.getElementById('copy-share-link-btn')?.addEventListener('click', () => handleCopyShareCode(gameData.roomId));
        }

        function handleCopyShareCode(roomId) {
            const shareCode = roomId;
            const textArea = document.createElement("textarea");
            textArea.value = shareCode;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy') ? showToast("Room Code copied!", "success") : showToast("Failed to copy code.", "error");
            } catch (err) {
                showToast("Failed to copy code.", "error");
            }
            document.body.removeChild(textArea);
        }

        async function startGameRound() { await updateDoc(getGameRef(currentGameId), { gamePhase: 'setting_word' }); }
        
        async function handleSetWord(e) {
            e.preventDefault();
            const word = e.target.elements['secret-word-input'].value.trim().toUpperCase();
            if (!/^[A-Z]{5,12}$/.test(word)) { showToast("Word must be 5-12 letters.", "error"); return; }
            const gameRef = getGameRef(currentGameId);
            const gameData = (await getDoc(gameRef)).data();
            await updateDoc(gameRef, { secretWord: word, revealedCount: 1, directGuessesLeft: 3, currentReference: null, gamePhase: 'guessing', clueGiverTurn: 0, gameHistory: arrayUnion(`${gameData.players[currentUserId].name} set the word.`) });
        }
        
        async function handleSetClue(e) {
            e.preventDefault();
            const referenceWord = e.target.elements['reference-word-input'].value.trim();
            const clue = e.target.elements['clue-input'].value.trim();
            const gameRef = getGameRef(currentGameId);
            const gameData = (await getDoc(gameRef)).data();
            await updateDoc(gameRef, { currentReference: { clueGiverId: currentUserId, referenceWord: referenceWord.toLowerCase(), clue: clue, guesses: {}, setterAttempt: '' }, gameHistory: arrayUnion(`${gameData.players[currentUserId].name} gave the clue: "${clue}"`) });
        }
        
        async function handleGuesserReferenceGuess(e) { e.preventDefault(); await updateDoc(getGameRef(currentGameId), { [`currentReference.guesses.${currentUserId}`]: e.target.elements['guesser-reference-guess-input'].value.trim().toLowerCase() }); checkReferenceResolution(); }
        async function handleSetterReferenceGuess(e) {
            e.preventDefault();
            const guess = e.target.elements['setter-reference-guess-input'].value.trim().toLowerCase();
            if (!guess) return;

            const gameRef = getGameRef(currentGameId);
            const gameDoc = await getDoc(gameRef);
            if (!gameDoc.exists()) return;
            const gameData = gameDoc.data();
            const { currentReference, players } = gameData;

            if (!currentReference) return; // No active reference to guess

            if (guess === currentReference.referenceWord) {
                // Correct guess, update the doc and let checkReferenceResolution handle the failure state.
                await updateDoc(gameRef, { 'currentReference.setterAttempt': guess });
                checkReferenceResolution();
            } else {
                // Incorrect guess. Show feedback and log to history without ending the round.
                const setterName = players[Object.keys(players).find(id => players[id].role === 'setter')].name;
                await updateDoc(gameRef, {
                    gameHistory: arrayUnion(`${setterName} incorrectly guessed '${guess}'.`)
                });
                showToast(`'${guess}' is incorrect. Try again!`, 'error');
                e.target.reset(); // Clear the input for the next guess
            }
        }

        async function handleDirectGuess(e) {
            e.preventDefault();
            const guess = e.target.elements['direct-guess-input'].value.trim().toUpperCase();
            if (!guess) return;
            const gameRef = getGameRef(currentGameId);
            const gameData = (await getDoc(gameRef)).data();
            const newGuessesLeft = gameData.directGuessesLeft - 1;
            const batch = writeBatch(db);
            const playerName = gameData.players[currentUserId].name;
            if (guess === gameData.secretWord) {
                batch.update(gameRef, { gamePhase: 'ended', winner: 'guessers', gameHistory: arrayUnion(`${playerName} guessed the word: ${guess}!`) });
            } else {
                const historyUpdate = [`${playerName} guessed ${guess}. Incorrect!`, `${newGuessesLeft} direct guesses left.`];
                newGuessesLeft <= 0 ? batch.update(gameRef, { gamePhase: 'ended', winner: 'setter', directGuessesLeft: 0, gameHistory: arrayUnion(...historyUpdate, "Out of guesses.") }) : batch.update(gameRef, { directGuessesLeft: newGuessesLeft, gameHistory: arrayUnion(...historyUpdate) });
            }
            await batch.commit();
        }
        
        async function checkReferenceResolution() {
            const gameRef = getGameRef(currentGameId);
            const gameDoc = await getDoc(gameRef);
            if (!gameDoc.exists()) return;
            const gameData = gameDoc.data();
            const { currentReference, players, secretWord, clueGiverTurn } = gameData;
            if (!currentReference) return;

            const batch = writeBatch(db);
            const setterName = players[Object.keys(players).find(id => players[id].role === 'setter')].name;
            const guesserIds = Object.keys(players).filter(id => players[id].role === 'guesser').sort();
            const nextTurn = guesserIds.length > 0 ? ((clueGiverTurn || 0) + 1) : 0;

            if (currentReference.setterAttempt && currentReference.setterAttempt === currentReference.referenceWord) {
                batch.update(gameRef, { currentReference: null, clueGiverTurn: nextTurn, gameHistory: arrayUnion(`${setterName} guessed '${currentReference.referenceWord}'! Round failed.`) });
                await batch.commit(); return;
            }

            const activeGuesserIds = guesserIds.filter(id => id !== currentReference.clueGiverId);
            if (activeGuesserIds.length === 0) { // All guessers might be giving clues in small games
                // If the clue giver is the only guesser, there's no one to guess. This might be a game state to handle.
                // For now, we assume at least one other guesser or the setter must act.
                // If setter has attempted, it is handled above. If not, we wait.
                return; 
            }

            const guesses = currentReference.guesses || {};
            const allGuessed = activeGuesserIds.every(id => guesses[id]);
            
            if (allGuessed) {
                const firstGuess = guesses[activeGuesserIds[0]];
                const allMatch = activeGuesserIds.every(id => guesses[id] === firstGuess);
                if (allMatch && firstGuess === currentReference.referenceWord) {
                    const nextLetter = secretWord[gameData.revealedCount];
                    if (nextLetter) {
                        const newRevealedCount = gameData.revealedCount + 1;
                        newRevealedCount === secretWord.length 
                            ? batch.update(gameRef, { gamePhase: 'ended', winner: 'guessers', revealedCount: newRevealedCount, gameHistory: arrayUnion(`All letters revealed!`) }) 
                            : batch.update(gameRef, { revealedCount: newRevealedCount, currentReference: null, clueGiverTurn: nextTurn, gameHistory: arrayUnion(`Success! Revealed '${nextLetter}'.`) });
                    }
                } else {
                    batch.update(gameRef, { currentReference: null, clueGiverTurn: nextTurn, gameHistory: arrayUnion(`Guesses didn't match. Round failed.`) });
                }
                await batch.commit();
            }
        }
        
        async function playAgain() {
            await updateDoc(getGameRef(currentGameId), { gamePhase: 'lobby', secretWord: '', revealedCount: 0, currentReference: null, winner: null, gameHistory: ["A new round is starting."] });
            hideModal();
        }

        // --- 9. INITIALIZE ---
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', joinGame);
        document.getElementById('play-again-btn').addEventListener('click', playAgain);
        
        initializeAppAndAuth();

    </script>
</body>
</html>

