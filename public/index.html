<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect | a collaborative word game</title>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="shortcut icon" href="favicon/favicon.ico">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* View switching and modal transitions */
        .view, .modal-overlay {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .view.active {
            display: block; /* Lobby and Game views are blocks */
            opacity: 1;
        }
        .modal-overlay.active {
             display: flex; /* Use flex for centering modal */
             opacity: 1;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        /* Higher z-index for confirmation modal */
        #remove-player-modal {
            z-index: 110;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 110;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: toast-in 0.5s forwards;
        }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        .toast.info { background-color: #3b82f6; }
        .toast.error { background-color: #ef4444; }
        .toast.success { background-color: #22c55e; }
        /* Survey Rating Styles */
        .rating-option input:checked + div {
            background-color: #4f46e5;
            border-color: #4f46e5;
            color: white;
        }
        .rating-option:hover div {
            border-color: #6366f1;
            background-color: #f0f0ff;
        }
        .rating-option input:checked + div:hover {
            background-color: #4338ca;
            border-color: #4338ca;
            color: white;
        }
        /* Floating Feedback Button */
        .floating-feedback-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 3.5rem;
            height: 3.5rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 50;
            border: none;
            font-size: 1.25rem;
        }
        .floating-feedback-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        .floating-feedback-btn:active {
            transform: scale(0.95);
        }
        @media (max-width: 640px) {
            .floating-feedback-btn {
                bottom: 1rem;
                right: 1rem;
                width: 3rem;
                height: 3rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen">

    <!-- Main App Container -->
    <div class="w-full max-w-4xl mx-auto p-4">
        <div id="app-container" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">
            <!-- Lobby View -->
            <div id="lobby-view" class="view active">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <h1 class="text-4xl font-bold text-slate-900">Connect</h1>
                    <button id="info-btn" class="text-slate-500 hover:text-slate-700 hover:bg-slate-100 p-2 rounded-full transition-colors" title="How to Play">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                    </button>
                </div>
                <p class="text-center text-slate-500 mb-8">A collaborative word guessing game.</p>
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
                    <label for="username-input" class="block text-sm font-medium text-slate-700 mb-1 text-center">Your Nickname:</label>
                    <input type="text" id="username-input" class="w-full font-mono text-lg text-center text-indigo-600 bg-transparent border-0 focus:ring-0" value="Connecting...">
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="create-game-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Create New Game
                    </button>
                </div>
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-300"></div></div>
                    <div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-slate-500">OR</span></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="join-code-input" placeholder="Paste Share Code to join" class="flex-grow w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="join-game-btn" class="w-full sm:w-auto bg-slate-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Join Game
                    </button>
                </div>
            </div>
            <!-- Game View (Dynamically populated) -->
            <div id="game-view" class="view"></div>
        </div>
        <!-- <p class="text-center text-sm text-slate-400 mt-4">Powered by Firebase & Tailwind CSS</p> -->
    </div>

    <!-- End of Round Modal -->
    <div id="end-round-modal" class="modal-overlay">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
            <h2 id="modal-title" class="text-3xl font-bold text-slate-900 mb-4">Round Over!</h2>
            <p id="modal-body" class="text-slate-600 mb-6">The secret word was:</p>
            <p id="modal-secret-word" class="font-mono text-2xl bg-slate-100 text-indigo-600 py-2 px-4 rounded-lg inline-block mb-6"></p>
            <button id="play-again-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700">Play Again</button>
        </div>
    </div>

    <!-- Remove Player Confirmation Modal -->
    <div id="remove-player-modal" class="modal-overlay">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">Remove Player</h2>
            <p class="text-slate-600 mb-6">Are you sure you want to remove <span id="remove-player-name" class="font-semibold"></span> from the game?</p>
            <div class="flex gap-3">
                <button id="cancel-remove-btn" class="flex-1 bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="confirm-remove-btn" class="flex-1 bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700">Remove</button>
            </div>
        </div>
    </div>

    <!-- Players Modal (for game phase) -->
    <div id="players-modal" class="modal-overlay">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-900">Players</h2>
                <button id="close-players-modal" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div id="players-modal-content">
                <!-- Players list will be populated here -->
            </div>
        </div>
    </div>

    <!-- Role Selection Modal -->
    <div id="role-modal" class="modal-overlay">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl max-w-md w-full text-center">
            <h2 class="text-xl font-bold text-slate-900 mb-4">Select the Word Setter</h2>
            <form id="role-form" class="space-y-2 mb-6 text-left"></form>
            <div class="flex gap-3">
                <button id="cancel-role-btn" type="button" class="flex-1 bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="confirm-role-btn" type="button" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700" disabled>Save</button>
            </div>
        </div>
    </div>

    <!-- How to Play Info Modal -->
    <div id="info-modal" class="modal-overlay">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">How to Play</h2>
                <button id="close-info-modal" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Step 1 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">1</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Setup <span class="text-xl">üéØ</span>
                        </h3>
                        <p class="text-slate-600">One player becomes the Word Setter and chooses a secret word. Everyone else becomes Guessers.</p>
                    </div>
                </div>
                
                <!-- Step 2 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">2</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Give Clues <span class="text-xl">üí°</span>
                        </h3>
                        <p class="text-slate-600">Guessers take turns being the Clue Giver. They think of a reference word that fits the revealed letters and give a clue.</p>
                    </div>
                </div>
                
                <!-- Step 3 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">3</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Match & Reveal <span class="text-xl">üîç</span>
                        </h3>
                        <p class="text-slate-600">Other Guessers try to guess the same reference word. If they match (and beat the Setter), a new letter is revealed!</p>
                    </div>
                </div>
                
                <!-- Step 4 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">4</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Win the Game <span class="text-xl">üèÜ</span>
                        </h3>
                        <p class="text-slate-600">Guessers win by revealing the full word or making a correct direct guess. Setter wins by blocking them!</p>
                    </div>
                </div>
            </div>
            
            <!-- Progress dots -->
            <div class="flex justify-center gap-2 mt-6 mb-4">
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
            </div>
            
            <div class="text-center">
                <button id="got-it-btn" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    Got it!
                </button>
            </div>
        </div>
    </div>

    <!-- How to Play Info Modal -->
    <div id="info-modal" class="modal-overlay">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">How to Play</h2>
                <button id="close-info-modal" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Step 1 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">1</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Setup <span class="text-xl">üéØ</span>
                        </h3>
                        <p class="text-slate-600">One player becomes the Word Setter and chooses a secret word. Everyone else becomes Guessers.</p>
                    </div>
                </div>
                
                <!-- Step 2 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">2</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Give Clues <span class="text-xl">üí°</span>
                        </h3>
                        <p class="text-slate-600">Guessers take turns being the Clue Giver. They think of a reference word that fits the revealed letters and give a clue.</p>
                    </div>
                </div>
                
                <!-- Step 3 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">3</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Match & Reveal <span class="text-xl">üîç</span>
                        </h3>
                        <p class="text-slate-600">Other Guessers try to guess the same reference word. If they match (and beat the Setter), a new letter is revealed!</p>
                    </div>
                </div>
                
                <!-- Step 4 -->
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-sm font-bold text-indigo-600">4</div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2 flex items-center gap-2">
                            Win the Game <span class="text-xl">üèÜ</span>
                        </h3>
                        <p class="text-slate-600">Guessers win by revealing the full word or making a correct direct guess. Setter wins by blocking them!</p>
                    </div>
                </div>
            </div>
            
            <!-- Progress dots -->
            <div class="flex justify-center gap-2 mt-6 mb-4">
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
            </div>
            
            <div class="text-center">
                <button id="got-it-btn" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    Got it!
                </button>
            </div>
        </div>
    </div>

    <!-- Satisfaction Survey Modal -->
    <div id="satisfaction-survey-modal" class="modal-overlay">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl max-w-md w-full">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-slate-900 mb-2">How was this round?</h2>
                <p class="text-slate-600 text-sm">Help us improve the game!</p>
            </div>
            
            <form id="satisfaction-survey-form">
                <!-- Rating Scale -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-3">How satisfied are you with this round?</label>
                    <div class="flex justify-between items-center gap-1">
                        <span class="text-xs text-slate-500">Not at all</span>
                        <div class="flex gap-2">
                            <label class="rating-option flex flex-col items-center cursor-pointer">
                                <input type="radio" name="satisfaction" value="1" class="sr-only">
                                <div class="w-8 h-8 rounded-full border-2 border-slate-300 flex items-center justify-center text-sm font-bold transition-all hover:border-indigo-400">1</div>
                            </label>
                            <label class="rating-option flex flex-col items-center cursor-pointer">
                                <input type="radio" name="satisfaction" value="2" class="sr-only">
                                <div class="w-8 h-8 rounded-full border-2 border-slate-300 flex items-center justify-center text-sm font-bold transition-all hover:border-indigo-400">2</div>
                            </label>
                            <label class="rating-option flex flex-col items-center cursor-pointer">
                                <input type="radio" name="satisfaction" value="3" class="sr-only">
                                <div class="w-8 h-8 rounded-full border-2 border-slate-300 flex items-center justify-center text-sm font-bold transition-all hover:border-indigo-400">3</div>
                            </label>
                            <label class="rating-option flex flex-col items-center cursor-pointer">
                                <input type="radio" name="satisfaction" value="4" class="sr-only">
                                <div class="w-8 h-8 rounded-full border-2 border-slate-300 flex items-center justify-center text-sm font-bold transition-all hover:border-indigo-400">4</div>
                            </label>
                            <label class="rating-option flex flex-col items-center cursor-pointer">
                                <input type="radio" name="satisfaction" value="5" class="sr-only">
                                <div class="w-8 h-8 rounded-full border-2 border-slate-300 flex items-center justify-center text-sm font-bold transition-all hover:border-indigo-400">5</div>
                            </label>
                            <label class="rating-option flex flex-col items-center cursor-pointer">
                                <input type="radio" name="satisfaction" value="6" class="sr-only">
                                <div class="w-8 h-8 rounded-full border-2 border-slate-300 flex items-center justify-center text-sm font-bold transition-all hover:border-indigo-400">6</div>
                            </label>
                            <label class="rating-option flex flex-col items-center cursor-pointer">
                                <input type="radio" name="satisfaction" value="7" class="sr-only">
                                <div class="w-8 h-8 rounded-full border-2 border-slate-300 flex items-center justify-center text-sm font-bold transition-all hover:border-indigo-400">7</div>
                            </label>
                        </div>
                        <span class="text-xs text-slate-500">Very satisfied</span>
                    </div>
                </div>

                <!-- Optional Comment -->
                <div class="mb-6">
                    <label for="survey-comment" class="block text-sm font-medium text-slate-700 mb-2">One thing we should fix (optional)</label>
                    <textarea 
                        id="survey-comment" 
                        name="comment" 
                        rows="3" 
                        placeholder="What could make this game better?"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm resize-none"
                    ></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="button" id="skip-survey-btn" class="flex-1 bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">
                        Skip
                    </button>
                    <button type="submit" id="submit-survey-btn" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors" disabled>
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Floating Feedback Button -->
    <button id="floating-feedback-btn" class="floating-feedback-btn" title="Send Feedback">
        üí¨
    </button>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal-overlay">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-900">Send Feedback</h2>
                <button id="close-feedback-modal" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            
            <form id="feedback-form">
                <!-- Category Dropdown -->
                <div class="mb-4">
                    <label for="feedback-category" class="block text-sm font-medium text-slate-700 mb-2">Category *</label>
                    <select id="feedback-category" name="category" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <option value="">Select a category...</option>
                        <option value="bug">Bug</option>
                        <option value="idea">Idea</option>
                        <option value="confusing">Confusing</option>
                    </select>
                </div>



                <!-- Message -->
                <div class="mb-6">
                    <label for="feedback-message" class="block text-sm font-medium text-slate-700 mb-2">Message *</label>
                    <textarea 
                        id="feedback-message" 
                        name="message" 
                        rows="4" 
                        placeholder="Describe the issue or share your idea..."
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm resize-none"
                        minlength="10"
                        required
                    ></textarea>
                    <div class="text-xs text-slate-500 mt-1">
                        <span id="feedback-char-count">0</span> / 10 minimum characters
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="button" id="cancel-feedback-btn" class="flex-1 bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="submit-feedback-btn" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors" disabled>
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Firebase and Game Logic Script -->
    <script type="module">
        // Import Firebase configuration
        import { firebaseConfig } from './config.js';
        
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, writeBatch } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        

        // --- 1. CONFIGURATION & INITIALIZATION ---
        // TODO: Replace with your actual Firebase configuration from your Firebase project.
        // 1. Go to the Firebase console (console.firebase.google.com).
        // 2. Create a new project or use an existing one.
        // 3. Add a new Web App to your project.
        // 4. Copy the firebaseConfig object here.
        // const firebaseConfig = {
        //   apiKey: "YOUR_API_KEY",
        //   authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        //   projectId: "YOUR_PROJECT_ID",
        //   storageBucket: "YOUR_PROJECT_ID.appspot.com",
        //   messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        //   appId: "YOUR_APP_ID",
        //   measurementId: "YOUR_MEASUREMENT_ID",
        // };

       
        let db, auth, analytics;
        let currentUserId = null;
        let currentGameId = null;
        let unsubscribeFromGame = null;

        // DOM Element References
        const usernameInput = document.getElementById('username-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const joinCodeInput = document.getElementById('join-code-input');
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        const endRoundModal = document.getElementById('end-round-modal');

        // --- 2. UTILITY FUNCTIONS ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toast-out 0.5s forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        }

        function getGameRef(roomId) {
            return doc(db, "game_rooms", roomId);
        }

        function generateCreativeUsername() {
            const adjectives = ["Agile", "Bright", "Clever", "Daring", "Eager", "Fearless", "Gallant", "Happy", "Jolly", "Keen"];
            const animals = ["Alpaca", "Bear", "Cat", "Dolphin", "Eagle", "Fox", "Giraffe", "Hippo", "Iguana", "Jaguar"];
            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
            return `${randomAdjective}${randomAnimal}${Math.floor(Math.random() * 900) + 100}`;
        }

        // --- ANALYTICS FUNCTIONS ---
        function getEnvironment() {
            // Detect environment based on hostname
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('localhost')) {
                return 'dev';
            }
            // You can add more specific staging/prod detection logic here
            return 'prod';
        }

        // --- SURVEY FUNCTIONS ---
        function generateSessionId() {
            let sessionId = localStorage.getItem('connect_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('connect_session_id', sessionId);
            }
            return sessionId;
        }

        function shouldShowSurvey() {
            // Check 24-hour rate limiting
            const lastSurveyTime = localStorage.getItem('connect_last_survey');
            const now = Date.now();
            // const twentyFourHours = 24 * 60 * 60 * 1000;
            const tenMinutes = 10 * 60 * 1000;
            const threshold = tenMinutes;
            
            if (lastSurveyTime && (now - parseInt(lastSurveyTime)) < threshold) {
                return false; // Already shown within threshold time
            }
            
            // 1-in-5 chance (20%)
            return Math.random() < 0.2;
        }

        function showSurveyModal(gameData) {
            if (!shouldShowSurvey()) {
                return;
            }
            
            // Show survey after a short delay to let users process the round result
            setTimeout(() => {
                document.getElementById('satisfaction-survey-modal').classList.add('active');
                
                // Store game data for survey submission
                window.currentSurveyData = {
                    roomId: gameData.roomId || currentGameId,
                    roundNumber: gameData.roundNumber || 1,
                    winner: gameData.winner,
                    sessionId: generateSessionId()
                };
            }, 2000); // 2 second delay
        }

        function hideSurveyModal() {
            document.getElementById('satisfaction-survey-modal').classList.remove('active');
            // Reset form
            document.getElementById('satisfaction-survey-form').reset();
            updateSurveySubmitButton();
        }

        function updateSurveySubmitButton() {
            const form = document.getElementById('satisfaction-survey-form');
            const submitBtn = document.getElementById('submit-survey-btn');
            const selectedRating = form.querySelector('input[name="satisfaction"]:checked');
            
            submitBtn.disabled = !selectedRating;
        }

        async function submitSurvey(rating, comment) {
            try {
                if (!window.currentSurveyData) {
                    throw new Error('Survey data not available');
                }

                const surveyData = {
                    roomId: window.currentSurveyData.roomId,
                    roundNumber: window.currentSurveyData.roundNumber,
                    winner: window.currentSurveyData.winner,
                    rating: parseInt(rating),
                    comment: comment.trim() || null,
                    createdAt: new Date(),
                    userId: currentUserId || null,
                    sessionId: window.currentSurveyData.sessionId
                };

                // Submit to Firestore
                const feedbackRef = doc(db, 'round_feedback', crypto.randomUUID());
                await setDoc(feedbackRef, surveyData);

                // Update rate limiting
                localStorage.setItem('connect_last_survey', Date.now().toString());

                // Show success feedback
                showToast("Thanks for the feedback!", "success");
                hideSurveyModal();

            } catch (error) {
                console.error('Error submitting survey:', error);
                showToast("Failed to submit feedback. Please try again.", "error");
            }
        }

        // --- FEEDBACK FUNCTIONS ---
        function showFeedbackModal() {
            document.getElementById('feedback-modal').classList.add('active');
            document.getElementById('feedback-category').focus();
        }

        function hideFeedbackModal() {
            document.getElementById('feedback-modal').classList.remove('active');
            // Reset form
            document.getElementById('feedback-form').reset();
            updateFeedbackSubmitButton();
        }

        function updateFeedbackSubmitButton() {
            const form = document.getElementById('feedback-form');
            const submitBtn = document.getElementById('submit-feedback-btn');
            const category = form.querySelector('#feedback-category').value;
            const message = form.querySelector('#feedback-message').value.trim();
            
            const isValid = category && message && message.length >= 10;
            submitBtn.disabled = !isValid;
        }

        function updateCharacterCount() {
            const messageInput = document.getElementById('feedback-message');
            const charCount = document.getElementById('feedback-char-count');
            charCount.textContent = messageInput.value.length;
        }



        function getCurrentGamePhase() {
            // Determine current game phase for feedback context
            if (!currentGameId) {
                return 'lobby-view';
            }
            
            // Try to determine from visible view
            if (document.getElementById('lobby-view').classList.contains('active')) {
                return 'lobby';
            } else if (document.getElementById('game-view').classList.contains('active')) {
                // Could be setting_word, guessing, or ended - we'd need game data to be precise
                return 'in-game';
            }
            
            return 'unknown';
        }

        async function submitFeedback(category, message) {
            try {
                const submitBtn = document.getElementById('submit-feedback-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sending...';

                const feedbackData = {
                    category: category,
                    message: message.trim(),
                    createdAt: new Date(),
                    userAgent: navigator.userAgent,
                    gamePhase: getCurrentGamePhase(),
                    roomId: currentGameId || null,
                    userId: currentUserId || null,
                    sessionId: generateSessionId()
                };

                // Submit to Firestore
                const feedbackRef = doc(db, 'feedback_detailed', crypto.randomUUID());
                await setDoc(feedbackRef, feedbackData);

                // Show success feedback
                showToast("Thanks for the feedback!", "success");
                hideFeedbackModal();

            } catch (error) {
                console.error('Error submitting feedback:', error);
                showToast("Failed to send feedback. Please try again.", "error");
                
                // Reset submit button
                const submitBtn = document.getElementById('submit-feedback-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send';
            }
        }

        function logAnalyticsEvent(eventName, parameters = {}) {
            try {
                if (analytics) {
                    const environment = getEnvironment();
                    const prefixedEventName = `${environment}_${eventName}`;
                    
                    // Add environment to parameters for additional filtering
                    const enrichedParameters = {
                        ...parameters,
                        environment: environment
                    };
                    
                    logEvent(analytics, prefixedEventName, enrichedParameters);
                    console.log(`Analytics event logged: ${prefixedEventName}`, enrichedParameters);
                }
            } catch (error) {
                console.error(`Failed to log analytics event ${eventName}:`, error);
            }
        }

        function logAppSession() {
            logAnalyticsEvent('app_session', {
                timestamp: Date.now()
            });
        }

        function logGameCreated(roomId, playersCount) {
            logAnalyticsEvent('game_created', {
                room_id: roomId,
                players_count: playersCount
            });
        }

        function logGameStarted(roomId, playersCount, roundNumber = 1) {
            // Warn if player count is outside expected range
            if (playersCount < 3 || playersCount > 18) {
                console.warn(`Player count ${playersCount} is outside expected range (3-18) for room ${roomId}`);
            }
            
            logAnalyticsEvent('game_started', {
                room_id: roomId,
                players_count: playersCount,
                round_number: roundNumber
            });
        }

        function logGameEnded(roomId, playersCount, winner, roundNumber = 1) {
            // Warn if player count is outside expected range
            if (playersCount < 3 || playersCount > 18) {
                console.warn(`Player count ${playersCount} is outside expected range (3-18) for room ${roomId}`);
            }
            
            logAnalyticsEvent('game_ended', {
                room_id: roomId,
                players_count: playersCount,
                round_number: roundNumber,
                winner: winner
            });
        }

        // --- 3. AUTHENTICATION ---
        async function initializeAppAndAuth() {
            try {
                // Check if the Firebase config has been filled out
                if (firebaseConfig.apiKey.startsWith("REPLACE_WITH_YOUR")) {
                    console.error("Firebase configuration is not set. Please update it in index-web.html with your project's credentials.");
                    usernameInput.value = 'Config Error';
                    showToast("Firebase is not configured. Please get your credentials from the Firebase Console.", "error");
                    createGameBtn.disabled = true;
                    joinGameBtn.disabled = true;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if (usernameInput.value === 'Connecting...' || usernameInput.value === 'Connection Failed') {
                           usernameInput.value = generateCreativeUsername();
                        }
                        createGameBtn.disabled = false;
                        joinGameBtn.disabled = false;
                        
                        // Log app session analytics event
                        logAppSession();
                    } else {
                        currentUserId = null;
                        createGameBtn.disabled = true;
                        joinGameBtn.disabled = true;
                    }
                });
                
                // Use anonymous authentication
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                usernameInput.value = 'Connection Failed';
                showToast("Could not connect to game service. Please check your Firebase configuration.", "error");
            }
        }

        // --- 4. VIEW MANAGEMENT ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function showModal(title, body, secretWord) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal-secret-word').textContent = secretWord;
            endRoundModal.classList.add('active');
        }
        
        function hideModal() {
            endRoundModal.classList.remove('active');
        }

        // --- 5. LOBBY LOGIC ---
        async function createGame() {
            if (!currentUserId) return showToast("Authenticating... please wait.", "info");
            const customName = usernameInput.value.trim();
            if (!customName) return showToast("Please enter a nickname.", "error");

            const newRoomId = crypto.randomUUID().substring(0, 6).toUpperCase();
            const gameRef = getGameRef(newRoomId);

            try {
                await setDoc(gameRef, {
                    roomId: newRoomId,
                    gamePhase: 'lobby',
                    roundNumber: 1,
                    players: { [currentUserId]: { role: 'setter', name: customName } },
                    gameHistory: [ `${customName} created the game.` ]
                });
                
                // Log game created analytics event
                logGameCreated(newRoomId, 1);
                
                // Creator directly enters the game view
                currentGameId = newRoomId;
                showView('game-view');
                subscribeToGame(newRoomId);

            } catch (error) {
                console.error("Error creating game:", error);
                showToast("Could not create game. Please try again.", "error");
            }
        }

        async function joinGame() {
            const joinCode = joinCodeInput.value.trim();
            if (!joinCode) { showToast("Please paste a Room Code.", "info"); return; }
            if (!currentUserId) { showToast("Still connecting... Please try again in a moment.", "info"); return; }
            const customName = usernameInput.value.trim();
            if (!customName || customName === 'Connecting...') { showToast("Please set a nickname first.", "error"); return; }
            
            const roomIdToJoin = joinCode;
            const gameRef = getGameRef(roomIdToJoin);

            try {
                const gameDoc = await getDoc(gameRef);
                if (!gameDoc.exists()) { showToast("Game room not found.", "error"); return; }
                
                currentGameId = roomIdToJoin;
                const gameData = gameDoc.data();

                if (!gameData.players[currentUserId]) {
                    await updateDoc(gameRef, {
                        [`players.${currentUserId}`]: { role: 'guesser', name: customName },
                        gameHistory: arrayUnion(`${customName} joined the game.`)
                    });
                }
                
                showView('game-view');
                subscribeToGame(roomIdToJoin);
            } catch (error) {
                console.error("Error joining game:", error);
                showToast("Failed to join game. Check the code and your connection.", "error");
            }
        }

        // --- 6. GAME STATE & RENDERING ---
        function subscribeToGame(roomId) {
            if (unsubscribeFromGame) unsubscribeFromGame();
            const gameRef = getGameRef(roomId);
            unsubscribeFromGame = onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) {
                    showToast("The game room was deleted.", "info");
                    showView('lobby-view');
                    currentGameId = null;
                    if(unsubscribeFromGame) unsubscribeFromGame();
                    return;
                }
                const gameData = doc.data();
                
                // Check if current player has been removed
                if (!gameData.players[currentUserId]) {
                    showToast("You were removed from the room.", "error");
                    showView('lobby-view');
                    currentGameId = null;
                    if(unsubscribeFromGame) unsubscribeFromGame();
                    hidePlayersModal();
                    hideRemovePlayerModal();
                    return;
                }
                
                renderGame(gameData);
                handleGamePhaseChange(gameData);
            }, (error) => {
                console.error("Snapshot listener error:", error);
                showToast("Connection to game lost.", "error");
            });
        }
        
        function handleGamePhaseChange(gameData) {
            if (gameData.gamePhase === 'ended' && !endRoundModal.classList.contains('active')) {
                const currentPlayer = gameData.players[currentUserId];
                const currentPlayerRole = currentPlayer?.role;
                const winner = gameData.winner;
                
                // Determine if the current player's team won
                const playerWon = (currentPlayerRole === 'guesser' && winner === 'guessers') || 
                                 (currentPlayerRole === 'setter' && winner === 'setter');
                
                // Check if this was a climactic victory (check recent game history)
                const isClimaticVictory = gameData.gameHistory && 
                    gameData.gameHistory.some(entry => entry.includes('üéâ The reference word IS the secret word!'));
                
                let title, body;
                if (isClimaticVictory) {
                    if (currentPlayerRole === 'guesser') {
                        title = "üéâ Victory! üéâ";
                        body = "The reference word IS the secret word! You won! The secret word was:";
                    } else {
                        title = "Guessers Won!";
                        body = "Round Over. The secret word was:";
                    }
                } else {
                    title = playerWon ? "You Win!" : "Round Over!";
                    body = `The ${gameData.winner} won. The secret word was:`;
                }
                
                showModal(title, body, gameData.secretWord);
                
                // Show survey modal after the round ends
                showSurveyModal(gameData);
            } else if (gameData.gamePhase !== 'ended') {
                hideModal();
            }
        }

        function renderGame(gameData) {
            const player = gameData.players[currentUserId];
            if (!player) return;
            let content = '';
            if (gameData.gamePhase === 'lobby') {
                content = renderLobbyPhase(gameData, player);
            } else if (gameData.gamePhase === 'setting_word') {
                const setter = Object.values(gameData.players).find(p => p.role === 'setter');
                content = player.role === 'setter' 
                    ? renderSetterWordChoice() 
                    : `<p class="text-center text-slate-500 text-lg">Waiting for ${setter?.name || 'the Setter'} to choose a word...</p>`;
            } else if (gameData.gamePhase === 'guessing' || gameData.gamePhase === 'ended') {
                content = renderGuessingPhase(gameData, player);
            }
            gameView.innerHTML = content;
            addEventListenersToGame(gameData);
        }

        // --- 7. UI TEMPLATES ---
        function renderLobbyPhase(gameData, player) {
            // Determine who the room creator is (the player who has setter role)
            const roomCreatorId = Object.keys(gameData.players).find(uid => gameData.players[uid].role === 'setter');
            const isRoomCreator = currentUserId === roomCreatorId;
            
            const playersList = Object.keys(gameData.players).map(uid => {
                const p = gameData.players[uid];
                const isCurrentPlayer = uid === currentUserId;
                const canRemove = isRoomCreator && !isCurrentPlayer;
                
                const removeButton = canRemove ? 
                    `<button class="remove-player-btn ml-2 text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded" data-player-id="${uid}" data-player-name="${p.name}" title="Remove ${p.name}">üóëÔ∏è</button>` : '';

                const roleBadge = `<span class="text-xs font-mono px-2 py-1 rounded ${p.role === 'setter' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">${p.role}</span>`;

                return `<li class="font-semibold p-2 rounded flex justify-between items-center ${isCurrentPlayer ? 'bg-indigo-100' : ''}">
                        <span class="truncate">${p.name}</span>
                        <div class="flex items-center gap-2">
                            ${roleBadge}
                            ${removeButton}
                        </div>
                    </li>`;
            }).join('');
            let content = `
                <div class="text-center">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <h2 class="text-2xl font-bold">Game Lobby</h2>
                        <button id="lobby-info-btn" class="text-slate-500 hover:text-slate-700 hover:bg-slate-100 p-2 rounded-full transition-colors" title="How to Play">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-center gap-2 font-mono text-indigo-600 mb-4">
                        <span>Share this game:</span>
                        <button id="copy-share-link-btn" title="Copy Room Code" class="p-1 rounded-md hover:bg-indigo-100 flex items-center gap-1 bg-slate-100 border">
                            <span>${gameData.roomId}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/></svg>
                        </button>
                    </div>
                    ${isRoomCreator ? '<button id="edit-roles-btn" class="mb-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg">Edit Roles</button>' : ''}
                    <h3 class="font-bold text-lg mb-2">Players:</h3>
                    <ul class="space-y-1 mb-6">${playersList}</ul>`;
            if (player.role === 'setter') {
                content += `<button id="start-game-round-btn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700">Start Game</button>`;
            } else {
                content += `<p class="text-slate-500">Waiting for the Word Setter to start the game...</p>`;
            }
            content += `</div>`;
            return content;
        }

        function renderSetterWordChoice() {
            return `<div class="text-center"><h2 class="text-2xl font-bold text-slate-900 mb-4">You are the Word Setter!</h2><p class="text-slate-600 mb-6">Choose a secret word (5-12 letters).</p><form id="set-word-form" class="flex flex-col sm:flex-row gap-2"><input type="text" id="secret-word-input" class="flex-grow w-full px-4 py-3 border rounded-lg" required minlength="5" maxlength="12" pattern="[a-zA-Z]+"><button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg">Set Word</button></form></div>`;
        }
        
        function renderGuessingPhase(gameData, player) {
            const revealedWord = gameData.secretWord.split('').map((letter, index) => index < gameData.revealedCount ? `<span class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center text-2xl font-bold bg-slate-200 rounded-md">${letter.toUpperCase()}</span>` : `<span class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center bg-slate-200 rounded-md"></span>`).join('');
            
            const { players, currentReference, clueGiverTurn } = gameData;
            const guesserIds = Object.keys(players).filter(id => players[id].role === 'guesser').sort();
            let nextClueGiverId = null;
            if (guesserIds.length > 0) {
                const turnIndex = clueGiverTurn || 0;
                nextClueGiverId = guesserIds[turnIndex % guesserIds.length];
            }
            const clueGiverId = currentReference?.clueGiverId || nextClueGiverId;

            const playersList = Object.keys(gameData.players).map(uid => {
                const p = gameData.players[uid];
                let roleDisplay, roleClasses;

                if (p.role === 'setter') {
                    roleDisplay = 'setter';
                    roleClasses = 'bg-red-100 text-red-800';
                } else if (uid === clueGiverId) {
                    roleDisplay = 'leader';
                    roleClasses = 'bg-blue-300 text-blue-800';
                } else {
                    roleDisplay = 'guesser';
                    roleClasses = 'bg-blue-100 text-blue-800';
                }

                const hasGuessed = gameData.currentReference?.guesses?.[uid];
                const badgeHTML = hasGuessed ? '<span class="ml-2 w-2.5 h-2.5 bg-green-500 rounded-full"></span>' : '';

                return `<li class="flex items-center justify-between p-2 rounded-lg ${uid === currentUserId ? 'bg-indigo-50' : ''}">
                            <span class="font-semibold truncate text-sm" title="${p.name}">${p.name}</span>
                            <span class="flex items-center">
                                <span class="text-xs font-mono px-2 py-1 rounded-full ${roleClasses}">${roleDisplay}</span>
                                ${badgeHTML}
                            </span>
                        </li>`;
            }).join('');

            const gameAreaContent = player.role === 'guesser' ? renderGuesserArea(gameData) : renderSetterArea(gameData);
            return `<div class="flex justify-between items-center mb-4"><div><h2 class="text-2xl font-bold">Game In Progress</h2><div class="flex items-center gap-2 font-mono text-indigo-600"><span>Room Code:</span><button id="copy-share-link-btn" title="Copy Room Code" class="p-1 rounded-md hover:bg-indigo-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/></svg></button></div></div><div class="flex items-center gap-3"><button id="show-players-btn" title="Show Players" class="p-2 rounded-md hover:bg-slate-100 text-slate-600 hover:text-slate-800"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/><path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/></svg></button><button id="game-info-btn" title="How to Play" class="p-2 rounded-md hover:bg-slate-100 text-slate-600 hover:text-slate-800"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></button><div class="text-right"><p class="text-sm text-slate-600">Direct Guesses</p><p class="text-2xl font-bold">${gameData.directGuessesLeft}</p></div></div></div><div class="mb-6 p-4 bg-slate-50 rounded-lg flex justify-center gap-2 flex-wrap">${revealedWord}</div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2 bg-white p-4 rounded-lg border">${gameAreaContent}</div><div class="bg-white p-4 rounded-lg border"><h3 class="font-bold text-lg mb-2">Players</h3><ul class="space-y-1">${playersList}</ul><h3 class="font-bold text-lg mt-4 mb-2">History</h3><ul class="text-xs text-slate-500 space-y-1 h-32 overflow-y-auto">${gameData.gameHistory.slice().reverse().map(h => `<li>- ${h}</li>`).join('')}</ul></div></div>`;
        }
        
        function renderGuesserArea(gameData) {
            const { currentReference, players, clueGiverTurn } = gameData;
            const guesserIds = Object.keys(players).filter(id => players[id].role === 'guesser').sort();
            
            let nextClueGiverId = null;
            if (guesserIds.length > 0) {
                const turnIndex = clueGiverTurn || 0;
                nextClueGiverId = guesserIds[turnIndex % guesserIds.length];
            }
            
            const clueGiverId = currentReference?.clueGiverId || nextClueGiverId;

            const isClueGiver = currentUserId === clueGiverId;
            let referenceUI = '';
            if (!currentReference) {
                 referenceUI = isClueGiver ? `<h3 class="font-bold text-lg mb-2">You are the Clue Giver!</h3><p class="text-slate-600 mb-4">Give a clue for a reference word.</p><form id="set-clue-form"><input type="text" id="reference-word-input" placeholder="Your Reference Word" class="w-full px-4 py-2 mb-2 border rounded-lg" required><input type="text" id="clue-input" placeholder="Your Clue for the Word" class="w-full px-4 py-2 mb-4 border rounded-lg" required><button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg">Set Clue</button></form>` : `<p class="text-center text-slate-500">Waiting for ${players[clueGiverId]?.name || 'a Clue Giver'} to provide a clue...</p>`;
            } else {
                const myGuess = currentReference.guesses?.[currentUserId];
                const isClimatic = currentReference.isClimactic;
                
                // Special styling for climactic rounds
                const climaticStyle = isClimatic ? 'bg-orange-50 border-2 border-orange-200 rounded-lg p-4' : '';
                const climaticHeader = isClimatic ? '<div class="text-center mb-3"><span class="inline-block bg-orange-200 text-orange-800 px-3 py-1 rounded-full text-sm font-bold">üéØ FINAL ROUND!</span></div>' : '';
                
                if (myGuess) { 
                    referenceUI = `<div class="${climaticStyle}">${climaticHeader}<p class="text-center text-lg text-green-600">Your guess '${myGuess}' is locked in! Waiting for others...</p></div>`; 
                }
                else if (currentUserId === currentReference.clueGiverId) { 
                    referenceUI = `<div class="${climaticStyle}">${climaticHeader}<p class="text-center text-slate-500">You gave the clue. Waiting for guesses...</p></div>`; 
                }
                else { 
                    const buttonText = isClimatic ? 'I Know It (Final Chance!)' : 'I Know It!';
                    referenceUI = `<div class="${climaticStyle}">${climaticHeader}<h3 class="font-bold text-lg mb-2">Clue from ${players[currentReference.clueGiverId].name}:</h3><p class="text-slate-600 mb-4 text-xl font-semibold">"${currentReference.clue}"</p><form id="guesser-guess-form"><input type="text" id="guesser-reference-guess-input" placeholder="What is the reference word?" class="w-full px-4 py-2 mb-4 border rounded-lg" required><button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg">${buttonText}</button></form></div>`; 
                }
            }
            return `<div class="mb-4">${referenceUI}</div><div class="mt-6 border-t pt-4"><h3 class="font-bold text-lg mb-2">Guess the Secret Word</h3><form id="direct-guess-form" class="flex gap-2"><input type="text" id="direct-guess-input" placeholder="Type the full secret word" class="flex-grow w-full px-4 py-2 border rounded-lg"><button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg" ${gameData.directGuessesLeft <= 0 ? 'disabled' : ''}>Guess</button></form></div>`;
        }

        function renderSetterArea(gameData) {
            const { currentReference } = gameData;
            if (!currentReference) return `<p class="text-center text-slate-500">Waiting for the Guessers to start a reference...</p>`;
            if (currentReference.setterAttempt) return `<p class="text-center text-lg text-blue-600">You guessed '${currentReference.setterAttempt}'. Waiting for resolution...</p>`;
            
            // Handle climactic round - disable setter's ability to guess
            if (currentReference.isClimactic) {
                return `
                    <div class="text-center p-4 bg-orange-50 border-2 border-orange-200 rounded-lg">
                        <h3 class="font-bold text-lg mb-2 text-orange-800">üéØ CLIMACTIC ROUND!</h3>
                        <p class="text-slate-600 mb-2">Clue: <span class="font-semibold text-xl">"${currentReference.clue}"</span></p>
                        <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-2">
                            <p class="text-yellow-800 font-medium">‚ö†Ô∏è You cannot intercept when the reference word matches the secret word.</p>
                        </div>
                        <p class="text-slate-600 italic">The guessers hold the fate of this round...</p>
                    </div>
                `;
            }
            
            return `<h3 class="font-bold text-lg mb-2">Sabotage the Guessers!</h3><p class="text-slate-600 mb-2">Clue: <span class="font-semibold text-xl">"${currentReference.clue}"</span></p><p class="text-slate-600 mb-4">Guess the reference word to stop them!</p><form id="setter-guess-form" class="flex gap-2"><input type="text" id="setter-reference-guess-input" placeholder="Guess the reference word" class="flex-grow w-full px-4 py-2 border rounded-lg"><button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Guess</button></form>`;
        }
        
        // --- 8. EVENT HANDLING & GAME LOGIC ---
        function addEventListenersToGame(gameData) {
            document.getElementById('start-game-round-btn')?.addEventListener('click', startGameRound);
            document.getElementById('set-word-form')?.addEventListener('submit', handleSetWord);
            document.getElementById('set-clue-form')?.addEventListener('submit', handleSetClue);
            document.getElementById('guesser-guess-form')?.addEventListener('submit', handleGuesserReferenceGuess);
            document.getElementById('setter-guess-form')?.addEventListener('submit', handleSetterReferenceGuess);
            document.getElementById('direct-guess-form')?.addEventListener('submit', handleDirectGuess);
            document.getElementById('copy-share-link-btn')?.addEventListener('click', () => handleCopyShareCode(gameData.roomId));
            document.getElementById('edit-roles-btn')?.addEventListener('click', () => showRoleSelectionModal(gameData));

            // Player removal event listeners
            document.querySelectorAll('.remove-player-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const playerId = e.target.getAttribute('data-player-id');
                    const playerName = e.target.getAttribute('data-player-name');
                    showRemovePlayerConfirmation(playerId, playerName);
                });
            });
            
            // Players modal event listeners
            document.getElementById('show-players-btn')?.addEventListener('click', () => showPlayersModal(gameData));
            document.getElementById('close-players-modal')?.addEventListener('click', hidePlayersModal);
            
            // Game info modal event listeners (both game lobby and in-progress)
            document.getElementById('game-info-btn')?.addEventListener('click', showInfoModal);
            document.getElementById('lobby-info-btn')?.addEventListener('click', showInfoModal);
            
            // Close modals when clicking outside
            document.getElementById('players-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'players-modal') hidePlayersModal();
            });
            document.getElementById('remove-player-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'remove-player-modal') hideRemovePlayerModal();
            });
        }

        function handleCopyShareCode(roomId) {
            const shareCode = roomId;
            const textArea = document.createElement("textarea");
            textArea.value = shareCode;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy') ? showToast("Room Code copied!", "success") : showToast("Failed to copy code.", "error");
            } catch (err) {
                showToast("Failed to copy code.", "error");
            }
            document.body.removeChild(textArea);
        }

        // Player removal functionality
        function showPlayersModal(gameData) {
            const roomCreatorId = Object.keys(gameData.players).find(uid => gameData.players[uid].role === 'setter');
            const isRoomCreator = currentUserId === roomCreatorId;
            
            const playersListContent = Object.keys(gameData.players).map(uid => {
                const p = gameData.players[uid];
                const isCurrentPlayer = uid === currentUserId;
                const canRemove = isRoomCreator && !isCurrentPlayer;
                
                let roleDisplay, roleClasses;
                if (p.role === 'setter') {
                    roleDisplay = 'setter';
                    roleClasses = 'bg-red-100 text-red-800';
                } else {
                    roleDisplay = 'guesser';
                    roleClasses = 'bg-blue-100 text-blue-800';
                }
                
                const removeButton = canRemove ? 
                    `<button class="remove-player-btn ml-2 text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded" data-player-id="${uid}" data-player-name="${p.name}" title="Remove ${p.name}">üóëÔ∏è</button>` : '';
                
                return `<li class="flex items-center justify-between p-3 rounded-lg ${isCurrentPlayer ? 'bg-indigo-50' : ''}">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">${p.name}</span>
                        <span class="text-xs font-mono px-2 py-1 rounded-full ${roleClasses}">${roleDisplay}</span>
                    </div>
                    ${removeButton}
                </li>`;
            }).join('');
            
            document.getElementById('players-modal-content').innerHTML = `<ul class="space-y-2">${playersListContent}</ul>`;
            document.getElementById('players-modal').classList.add('active');
            
            // Add event listeners for remove buttons in the modal
            document.querySelectorAll('#players-modal .remove-player-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const playerId = e.target.getAttribute('data-player-id');
                    const playerName = e.target.getAttribute('data-player-name');
                    showRemovePlayerConfirmation(playerId, playerName);
                });
            });
        }
        
        function hidePlayersModal() {
            document.getElementById('players-modal').classList.remove('active');
        }
        
        function showRemovePlayerConfirmation(playerId, playerName) {
            document.getElementById('remove-player-name').textContent = playerName;
            document.getElementById('remove-player-modal').classList.add('active');
            
            // Store the player info for the confirmation action
            document.getElementById('confirm-remove-btn').setAttribute('data-player-id', playerId);
            document.getElementById('confirm-remove-btn').setAttribute('data-player-name', playerName);
        }
        
        function hideRemovePlayerModal() {
            document.getElementById('remove-player-modal').classList.remove('active');
        }

        // Role selection modal helpers
        function showRoleSelectionModal(gameData) {
            const modal = document.getElementById('role-modal');
            const form = document.getElementById('role-form');
            // Build radio list
            form.innerHTML = Object.keys(gameData.players).map(uid => {
                const p = gameData.players[uid];
                const isSetter = p.role === 'setter';
                return `<label class="role-option flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-red-50 ${isSetter ? 'bg-red-100' : ''}">\n                            <input type="radio" name="selectedSetter" value="${uid}" class="text-indigo-600" ${isSetter ? 'checked' : ''}>\n                            <span class="flex-1 truncate font-semibold">${p.name}</span>\n                        </label>`;
            }).join('');
 
            const confirmBtn = document.getElementById('confirm-role-btn');
            confirmBtn.disabled = false;
 
            modal.classList.add('active');
 
            // Attach one-time listeners
            form.addEventListener('change', (e) => {
                if (e.target.name === 'selectedSetter') {
                    // Highlight selected row
                    form.querySelectorAll('.role-option').forEach(l => l.classList.remove('bg-red-100'));
                    e.target.closest('.role-option')?.classList.add('bg-red-100');
                    confirmBtn.disabled = false;
                }
            });
 
            // Save handler
            confirmBtn.onclick = async () => {
                const selected = form.querySelector('input[name="selectedSetter"]:checked')?.value;
                if (selected) {
                    await handleRoleChange(selected, 'setter');
                }
                hideRoleSelectionModal();
            };
        }

        function hideRoleSelectionModal() {
            document.getElementById('role-modal').classList.remove('active');
        }
        
        // Info modal functions
        function showInfoModal() {
            document.getElementById('info-modal').classList.add('active');
        }
        
        function hideInfoModal() {
            document.getElementById('info-modal').classList.remove('active');
        }
        
        async function removePlayer(playerId, playerName) {
            try {
                const gameRef = getGameRef(currentGameId);
                const gameDoc = await getDoc(gameRef);
                if (!gameDoc.exists()) return;
                
                const gameData = gameDoc.data();
                const updatedPlayers = { ...gameData.players };
                delete updatedPlayers[playerId];
                
                // Check if the removed player was the current clue giver
                const isCurrentClueGiver = gameData.currentReference?.clueGiverId === playerId;
                const guesserIds = Object.keys(gameData.players).filter(id => gameData.players[id].role === 'guesser').sort();
                const currentTurnIndex = gameData.clueGiverTurn || 0;
                const expectedClueGiverId = guesserIds.length > 0 ? guesserIds[currentTurnIndex % guesserIds.length] : null;
                const isExpectedClueGiver = expectedClueGiverId === playerId;
                
                let updateData = {
                    players: updatedPlayers,
                    gameHistory: arrayUnion(`${playerName} was removed from the game.`)
                };
                
                // If the removed player was the clue giver, handle the transition
                if (isCurrentClueGiver || isExpectedClueGiver) {
                    // Clear any current reference since the clue giver is gone
                    updateData.currentReference = null;
                    
                    // Calculate next clue giver turn from remaining guessers
                    const remainingGuesserIds = Object.keys(updatedPlayers).filter(id => updatedPlayers[id].role === 'guesser').sort();
                    
                    if (remainingGuesserIds.length > 0) {
                        // Find the next guesser after the removed one
                        let nextTurnIndex = currentTurnIndex;
                        
                        // If we removed someone before or at the current turn, keep the same index (which will point to the next person)
                        // If we removed someone after the current turn, no adjustment needed
                        const removedPlayerIndex = guesserIds.indexOf(playerId);
                        if (removedPlayerIndex !== -1 && removedPlayerIndex <= currentTurnIndex) {
                            // The removed player was at or before current turn, so we need to adjust
                            nextTurnIndex = currentTurnIndex; // This will now point to the next person
                        }
                        
                        // Make sure the index is valid for the remaining players
                        updateData.clueGiverTurn = nextTurnIndex % remainingGuesserIds.length;
                        
                        const nextClueGiver = updatedPlayers[remainingGuesserIds[updateData.clueGiverTurn]];
                        updateData.gameHistory = arrayUnion(
                            `${playerName} was removed from the game.`,
                            `${nextClueGiver.name} is now the clue giver.`
                        );
                    } else {
                        // No more guessers left, reset turn
                        updateData.clueGiverTurn = 0;
                    }
                }
                
                await updateDoc(gameRef, updateData);
                
                hideRemovePlayerModal();
                hidePlayersModal();
                showToast(`${playerName} has been removed from the game.`, "success");
                
            } catch (error) {
                console.error("Error removing player:", error);
                showToast("Failed to remove player. Please try again.", "error");
            }
        }

        // Handle role updates by the room creator in lobby
        async function handleRoleChange(playerId, newRole) {
            try {
                const gameRef = getGameRef(currentGameId);
                const gameDoc = await getDoc(gameRef);
                if (!gameDoc.exists()) return;

                const gameData = gameDoc.data();

                // Only allow role changes in lobby phase
                if (gameData.gamePhase !== 'lobby') {
                    showToast("You can only change roles in the lobby.", "error");
                    return;
                }

                const currentRole = gameData.players[playerId]?.role;
                if (currentRole === newRole) return; // no change

                const updates = {};

                if (newRole === 'setter') {
                    // Demote existing setters (should only be one)
                    Object.entries(gameData.players).forEach(([uid, pl]) => {
                        if (pl.role === 'setter' && uid !== playerId) {
                            updates[`players.${uid}.role`] = 'guesser';
                        }
                    });
                } else {
                    // Prevent removing the only setter
                    const setterIds = Object.keys(gameData.players).filter(id => gameData.players[id].role === 'setter');
                    if (setterIds.length === 1 && setterIds[0] === playerId) {
                        showToast("There must be at least one setter. Promote another player first.", "error");
                        return;
                    }
                }

                updates[`players.${playerId}.role`] = newRole;
                updates['gameHistory'] = arrayUnion(`${gameData.players[currentUserId].name} set ${gameData.players[playerId].name} as ${newRole}.`);

                await updateDoc(gameRef, updates);
            } catch (error) {
                console.error("Error changing role:", error);
                showToast("Failed to change role. Please try again.", "error");
            }
        }

        async function startGameRound() { await updateDoc(getGameRef(currentGameId), { gamePhase: 'setting_word' }); }
        
        async function handleSetWord(e) {
            e.preventDefault();
            const word = e.target.elements['secret-word-input'].value.trim().toUpperCase();
            if (!/^[A-Z]{5,12}$/.test(word)) { showToast("Word must be 5-12 letters.", "error"); return; }
            const gameRef = getGameRef(currentGameId);
            const gameData = (await getDoc(gameRef)).data();
            
            // Increment round number every time a word is set (except for the very first round)
            const currentRoundNumber = gameData.roundNumber || 1;
            const isNewRound = gameData.secretWord && gameData.secretWord !== '';
            const newRoundNumber = isNewRound ? currentRoundNumber + 1 : currentRoundNumber;
            
            // Log game started analytics event with round number
            const playersCount = Object.keys(gameData.players).length;
            logGameStarted(currentGameId, playersCount, newRoundNumber);
            
            await updateDoc(gameRef, { 
                secretWord: word, 
                revealedCount: 1, 
                directGuessesLeft: 3, 
                currentReference: null, 
                gamePhase: 'guessing', 
                clueGiverTurn: 0, 
                roundNumber: newRoundNumber,
                gameHistory: arrayUnion(`${gameData.players[currentUserId].name} set the word.`) 
            });
        }
        
        async function handleSetClue(e) {
            e.preventDefault();
            const referenceWord = e.target.elements['reference-word-input'].value.trim();
            const clue = e.target.elements['clue-input'].value.trim();
            const gameRef = getGameRef(currentGameId);
            const gameData = (await getDoc(gameRef)).data();
            
            // Check if this is a climactic round (reference word equals secret word)
            const isClimactic = referenceWord.toLowerCase() === gameData.secretWord.toLowerCase();
            
            const historyMessage = isClimactic 
                ? `${gameData.players[currentUserId].name} gave the clue: "${clue}"` 
                : `${gameData.players[currentUserId].name} gave the clue: "${clue}"`;
            
            await updateDoc(gameRef, { 
                currentReference: { 
                    clueGiverId: currentUserId, 
                    referenceWord: referenceWord.toLowerCase(), 
                    clue: clue, 
                    guesses: {}, 
                    setterAttempt: '', 
                    isClimactic: isClimactic 
                }, 
                gameHistory: arrayUnion(historyMessage) 
            });
        }
        
        async function handleGuesserReferenceGuess(e) { e.preventDefault(); await updateDoc(getGameRef(currentGameId), { [`currentReference.guesses.${currentUserId}`]: e.target.elements['guesser-reference-guess-input'].value.trim().toLowerCase() }); checkReferenceResolution(); }
        async function handleSetterReferenceGuess(e) {
            e.preventDefault();
            const guess = e.target.elements['setter-reference-guess-input'].value.trim().toLowerCase();
            if (!guess) return;

            const gameRef = getGameRef(currentGameId);
            const gameDoc = await getDoc(gameRef);
            if (!gameDoc.exists()) return;
            const gameData = gameDoc.data();
            const { currentReference, players } = gameData;

            if (!currentReference) return; // No active reference to guess

            if (guess === currentReference.referenceWord) {
                // Correct guess, update the doc and let checkReferenceResolution handle the failure state.
                await updateDoc(gameRef, { 'currentReference.setterAttempt': guess });
                checkReferenceResolution();
            } else {
                // Incorrect guess. Show feedback and log to history without ending the round.
                const setterName = players[Object.keys(players).find(id => players[id].role === 'setter')].name;
                await updateDoc(gameRef, {
                    gameHistory: arrayUnion(`${setterName} incorrectly guessed '${guess}'.`)
                });
                showToast(`'${guess}' is incorrect. Try again!`, 'error');
                e.target.reset(); // Clear the input for the next guess
            }
        }

        async function handleDirectGuess(e) {
            e.preventDefault();
            const guess = e.target.elements['direct-guess-input'].value.trim().toUpperCase();
            if (!guess) return;
            const gameRef = getGameRef(currentGameId);
            const gameData = (await getDoc(gameRef)).data();
            const newGuessesLeft = gameData.directGuessesLeft - 1;
            const batch = writeBatch(db);
            const playerName = gameData.players[currentUserId].name;
            const playersCount = Object.keys(gameData.players).length;
            const currentRoundNumber = gameData.roundNumber || 1;
            
            if (guess === gameData.secretWord) {
                batch.update(gameRef, { gamePhase: 'ended', winner: 'guessers', gameHistory: arrayUnion(`${playerName} guessed the word: ${guess}!`) });
                // Log game ended analytics event - guessers won
                logGameEnded(currentGameId, playersCount, 'guessers', currentRoundNumber);
            } else {
                const historyUpdate = [`${playerName} guessed ${guess}. Incorrect!`, `${newGuessesLeft} direct guesses left.`];
                if (newGuessesLeft <= 0) {
                    batch.update(gameRef, { gamePhase: 'ended', winner: 'setter', directGuessesLeft: 0, gameHistory: arrayUnion(...historyUpdate, "Out of guesses.") });
                    // Log game ended analytics event - setter won
                    logGameEnded(currentGameId, playersCount, 'setter', currentRoundNumber);
                } else {
                    batch.update(gameRef, { directGuessesLeft: newGuessesLeft, gameHistory: arrayUnion(...historyUpdate) });
                }
            }
            await batch.commit();
        }
        
        async function checkReferenceResolution() {
            const gameRef = getGameRef(currentGameId);
            const gameDoc = await getDoc(gameRef);
            if (!gameDoc.exists()) return;
            const gameData = gameDoc.data();
            const { currentReference, players, secretWord, clueGiverTurn } = gameData;
            if (!currentReference) return;

            const batch = writeBatch(db);
            const setterName = players[Object.keys(players).find(id => players[id].role === 'setter')].name;
            const guesserIds = Object.keys(players).filter(id => players[id].role === 'guesser').sort();
            const nextTurn = guesserIds.length > 0 ? ((clueGiverTurn || 0) + 1) : 0;

            // Handle climactic rounds specially
            if (currentReference.isClimactic) {
                const activeGuesserIds = guesserIds.filter(id => id !== currentReference.clueGiverId);
                if (activeGuesserIds.length === 0) return;

                const guesses = currentReference.guesses || {};
                const allGuessed = activeGuesserIds.every(id => guesses[id]);
                
                if (allGuessed) {
                    // In climactic rounds, guessers always win regardless of their actual guesses
                    const playersCount = Object.keys(gameData.players).length;
                    const currentRoundNumber = gameData.roundNumber || 1;
                    
                    batch.update(gameRef, { 
                        gamePhase: 'ended', 
                        winner: 'guessers', 
                        revealedCount: secretWord.length, // Reveal the entire word
                        gameHistory: arrayUnion('üéâ The reference word IS the secret word! Guessers Won! üéâ') 
                    });
                    
                    // Log climactic victory
                    logGameEnded(currentGameId, playersCount, 'guessers', currentRoundNumber);
                    await batch.commit();
                }
                return; // Exit early for climactic rounds
            }

            // Normal (non-climactic) resolution logic
            if (currentReference.setterAttempt && currentReference.setterAttempt === currentReference.referenceWord) {
                batch.update(gameRef, { currentReference: null, clueGiverTurn: nextTurn, gameHistory: arrayUnion(`${setterName} guessed '${currentReference.referenceWord}'! Round failed.`) });
                await batch.commit(); return;
            }

            const activeGuesserIds = guesserIds.filter(id => id !== currentReference.clueGiverId);
            if (activeGuesserIds.length === 0) { // All guessers might be giving clues in small games
                // If the clue giver is the only guesser, there's no one to guess. This might be a game state to handle.
                // For now, we assume at least one other guesser or the setter must act.
                // If setter has attempted, it is handled above. If not, we wait.
                return; 
            }

            const guesses = currentReference.guesses || {};
            const allGuessed = activeGuesserIds.every(id => guesses[id]);
            
            if (allGuessed) {
                const firstGuess = guesses[activeGuesserIds[0]];
                const allMatch = activeGuesserIds.every(id => guesses[id] === firstGuess);
                if (allMatch && firstGuess === currentReference.referenceWord) {
                    const nextLetter = secretWord[gameData.revealedCount];
                    if (nextLetter) {
                        const newRevealedCount = gameData.revealedCount + 1;
                        if (newRevealedCount === secretWord.length) {
                            batch.update(gameRef, { gamePhase: 'ended', winner: 'guessers', revealedCount: newRevealedCount, gameHistory: arrayUnion(`All letters revealed!`) });
                            // Log game ended analytics event - guessers won by revealing all letters
                            const playersCount = Object.keys(gameData.players).length;
                            const currentRoundNumber = gameData.roundNumber || 1;
                            logGameEnded(currentGameId, playersCount, 'guessers', currentRoundNumber);
                        } else {
                            batch.update(gameRef, { revealedCount: newRevealedCount, currentReference: null, clueGiverTurn: nextTurn, gameHistory: arrayUnion(`Success! Revealed '${nextLetter}'.`) });
                        }
                    }
                } else {
                    batch.update(gameRef, { currentReference: null, clueGiverTurn: nextTurn, gameHistory: arrayUnion(`Guesses didn't match. Round failed.`) });
                }
                await batch.commit();
            }
        }
        
        async function playAgain() {
            await updateDoc(getGameRef(currentGameId), { gamePhase: 'lobby', secretWord: '', revealedCount: 0, currentReference: null, winner: null, gameHistory: ["A new round is starting."] });
            hideModal();
        }

        // --- 9. INITIALIZE ---
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', joinGame);
        document.getElementById('play-again-btn').addEventListener('click', playAgain);
        
        // Remove player modal event listeners
        document.getElementById('cancel-remove-btn').addEventListener('click', hideRemovePlayerModal);
        document.getElementById('confirm-remove-btn').addEventListener('click', (e) => {
            const playerId = e.target.getAttribute('data-player-id');
            const playerName = e.target.getAttribute('data-player-name');
            removePlayer(playerId, playerName);
        });

        // Role modal event listeners
        document.getElementById('cancel-role-btn').addEventListener('click', hideRoleSelectionModal);
        
        // Info modal event listeners
        document.getElementById('info-btn').addEventListener('click', showInfoModal);
        document.getElementById('close-info-modal').addEventListener('click', hideInfoModal);
        document.getElementById('got-it-btn').addEventListener('click', hideInfoModal);
        
        // Close info modal when clicking outside or pressing escape
        document.getElementById('info-modal').addEventListener('click', (e) => {
            if (e.target.id === 'info-modal') hideInfoModal();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('info-modal').classList.contains('active')) {
                    hideInfoModal();
                }
                if (document.getElementById('feedback-modal').classList.contains('active')) {
                    hideFeedbackModal();
                }
            }
        });

        // Survey modal event listeners
        document.getElementById('satisfaction-survey-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rating = formData.get('satisfaction');
            const comment = formData.get('comment') || '';
            
            if (rating) {
                await submitSurvey(rating, comment);
            }
        });

        document.getElementById('skip-survey-btn').addEventListener('click', () => {
            hideSurveyModal();
            // Still update rate limiting so it doesn't show again for 24 hours
            localStorage.setItem('connect_last_survey', Date.now().toString());
        });

        // Survey rating change listeners
        document.querySelectorAll('input[name="satisfaction"]').forEach(radio => {
            radio.addEventListener('change', updateSurveySubmitButton);
        });

        // Close survey modal when clicking outside
        document.getElementById('satisfaction-survey-modal').addEventListener('click', (e) => {
            if (e.target.id === 'satisfaction-survey-modal') {
                hideSurveyModal();
                // Still update rate limiting so it doesn't show again for 24 hours
                localStorage.setItem('connect_last_survey', Date.now().toString());
            }
        });

        // Feedback modal event listeners
        document.getElementById('floating-feedback-btn').addEventListener('click', showFeedbackModal);
        document.getElementById('close-feedback-modal').addEventListener('click', hideFeedbackModal);
        document.getElementById('cancel-feedback-btn').addEventListener('click', hideFeedbackModal);

        // Feedback form validation
        document.getElementById('feedback-category').addEventListener('change', updateFeedbackSubmitButton);
        document.getElementById('feedback-message').addEventListener('input', () => {
            updateCharacterCount();
            updateFeedbackSubmitButton();
        });

        // Feedback form submission
        document.getElementById('feedback-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const category = formData.get('category');
            const message = formData.get('message');
            
            if (category && message && message.length >= 10) {
                await submitFeedback(category, message);
            }
        });

        // Close feedback modal when clicking outside
        document.getElementById('feedback-modal').addEventListener('click', (e) => {
            if (e.target.id === 'feedback-modal') {
                hideFeedbackModal();
            }
        });
        
        initializeAppAndAuth();

    </script>
</body>
</html>

